# ═══════════════════════════════════════════════════════════════════
# Agent 智能工作 (Python)
# 所有事件最终都归结为 PR 事件，由 Python Agent 处理
#
# 触发方式:
#   1. PR assigned → 新任务分配 (由 setup_pr.yml 触发)
#   2. issue_comment → @agent 评论 (人类反馈/审批)
#   3. pull_request_review_comment → 代码行内评论
# ═══════════════════════════════════════════════════════════════════
name: Autonomous Agent Runner

on:
  pull_request:
    types: [assigned]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  agent-work:
    if: >-
      (github.event_name == 'pull_request' && github.event.action == 'assigned') ||
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        contains(github.event.comment.body, '@agent')) ||
      (github.event_name == 'pull_request_review_comment')

    # 第一层并发控制: 按 PR 编号排队，同一 PR 的多个事件串行执行
    concurrency:
      group: pr-${{ github.event.pull_request.number || github.event.issue.number }}
      cancel-in-progress: false

    permissions:
      contents: write
      issues: write
      pull-requests: write

    # 使用自托管 runner（单机部署，无需亲和性调度）
    runs-on: [self-hosted]

    # 防止 Agent 陷入死循环的硬性熔断
    timeout-minutes: 15

    steps:
      # 前置校验: 确保评论中的 @agent 出现在正文而非引用块中
      # GitHub Actions 的 if 表达式只能做子字符串匹配，无法区分引用 vs 正文，
      # 因此用 bash 脚本做精确检查：剥离 '> ' 开头的引用行后，正文中必须包含 @agent
      - name: Validate Comment (Filter Quoted Mentions)
        id: validate_comment
        if: github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment'
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # 移除引用行 (以 > 开头)，只保留正文
          BODY_WITHOUT_QUOTES=$(echo "${COMMENT_BODY}" | grep -v '^>' || true)

          if echo "${BODY_WITHOUT_QUOTES}" | grep -q '@agent'; then
            echo "valid=true" >> "$GITHUB_OUTPUT"
            echo "Comment contains @agent in body text, proceeding"
          else
            echo "valid=false" >> "$GITHUB_OUTPUT"
            echo "Comment only contains @agent in quoted text, skipping"
          fi

      - name: Skip if Comment Invalid
        if: |
          (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
          steps.validate_comment.outputs.valid != 'true'
        run: |
          echo "::notice::Skipping: @agent only appeared in quoted text, not a direct mention"
          exit 1

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # PR 事件: 直接 checkout PR 的 head 分支
          # issue_comment 事件: 此处为空，后续步骤会切换到正确分支
          ref: ${{ github.event.pull_request.head.ref || '' }}

      # issue_comment 事件没有直接的 PR 上下文，需要查询
      - name: Resolve PR Context (Comment Events)
        id: comment_pr
        if: github.event_name == 'issue_comment'
        env:
          GH_REPO: ${{ github.repository }}
        run: |
          PR_NUMBER="${{ github.event.issue.number }}"
          BRANCH=$(gh pr view "${PR_NUMBER}" --json headRefName --jq '.headRefName')
          LABELS=$(gh pr view "${PR_NUMBER}" --json labels --jq '[.labels[].name] | join(",")')

          echo "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "branch_name=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "labels=${LABELS}" >> "$GITHUB_OUTPUT"

          # 切换到 PR 的 feature 分支
          git fetch origin
          git checkout -B "${BRANCH}" "origin/${BRANCH}"
          echo "Checked out branch ${BRANCH} for PR #${PR_NUMBER}"

      - name: Run Claude Agent
        id: run_agent
        env:
          WORKSPACE_ROOT: ${{ github.workspace }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          # ── 统一的 PR 事件上下文 ──────────────────────────────
          # pull_request / pull_request_review_comment 事件: 直接从事件获取
          # issue_comment 事件: 从 comment_pr 步骤获取
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          EVENT_ACTION: ${{ github.event.action }}
          EVENT_ASSIGNEE: ${{ github.event.assignee.login || '' }}
          PR_NUMBER: ${{ github.event.pull_request.number || steps.comment_pr.outputs.pr_number || '' }}
          BRANCH_NAME: ${{ github.event.pull_request.head.ref || steps.comment_pr.outputs.branch_name || '' }}
          LABELS: ${{ (github.event.pull_request && join(github.event.pull_request.labels.*.name, ',')) || steps.comment_pr.outputs.labels || '' }}
          USER_COMMENT: ${{ github.event.comment.body || '' }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login || '' }}
          # ── Review Comment 专属上下文 ──────────────────────────
          REVIEW_COMMENT_ID: ${{ github.event.comment.id || '' }}
          REVIEW_FILE_PATH: ${{ github.event.comment.path || '' }}
          REVIEW_DIFF_HUNK: ${{ github.event.comment.diff_hunk || '' }}
        shell: zsh {0}
        run: |
          echo "Sourcing .zshrc..."
          source ~/.zshrc
          echo "Running Agent..."
          imagecho-argos

      # 安全兜底: 即使 Python 进程崩溃，也能保证 PR 锁被释放
      - name: Release Agent Lock (Safety Net)
        if: always()
        env:
          GH_REPO: ${{ github.repository }}
        run: |
          # 锁目标始终是 PR
          LOCK_TARGET="${{ github.event.pull_request.number || steps.comment_pr.outputs.pr_number || '' }}"

          if [ -z "${LOCK_TARGET}" ]; then
            echo "::warning::Unable to determine PR number for lock release"
            exit 0
          fi

          echo "Releasing lock for PR #${LOCK_TARGET}..."
          if gh issue edit "${LOCK_TARGET}" --remove-label "agent:working" 2>/dev/null; then
            echo "Agent lock released for PR #${LOCK_TARGET}"
          else
            echo "::warning::Lock label may have been already removed"
          fi

      - name: Report Failure
        if: failure()
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GH_REPO: ${{ github.repository }}
        run: |
          REPORT_TARGET="${{ github.event.pull_request.number || steps.comment_pr.outputs.pr_number || '' }}"

          if [ -z "${REPORT_TARGET}" ]; then
            echo "::warning::Unable to determine PR number for failure report"
            exit 0
          fi

          echo "Reporting failure on PR #${REPORT_TARGET}..."

          # 添加 human:help-needed 标签
          gh issue edit "${REPORT_TARGET}" --add-label "human:help-needed"

          # 发表评论通知人类
          COMMENT_FILE=$(mktemp)
          printf '**Agent Execution Failed**\n\nThe autonomous agent encountered an error and requires human intervention.\n\n**Run Details:** %s\n\nPlease review the logs and provide guidance.' "${RUN_URL}" > "${COMMENT_FILE}"
          gh issue comment "${REPORT_TARGET}" --body-file "${COMMENT_FILE}"
          rm -f "${COMMENT_FILE}"

          echo "Failure notification sent to PR #${REPORT_TARGET}"
