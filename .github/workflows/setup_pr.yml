# ═══════════════════════════════════════════════════════════════════
# Issue → PR 基础设施 (纯 YAML，不走 Python)
# 创建分支和 PR，打上 stage:ready 标签后由 PR 事件触发 Agent
#
# 仅监听 issues:labeled 事件，避免 PR/Comment 事件产生无效运行
# ═══════════════════════════════════════════════════════════════════
name: Setup PR

on:
  issues:
    types: [labeled]

jobs:
  setup-pr:
    if: >-
      github.event.action == 'labeled' &&
      github.event.label.name == 'status:backlog'

    permissions:
      contents: write
      issues: write
      pull-requests: write

    runs-on: [self-hosted]
    timeout-minutes: 5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Branch and Draft PR
        env:
          GH_REPO: ${{ github.repository }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          BRANCH_NAME="feat/issue-${ISSUE_NUMBER}"

          # 1. 获取 Issue 标题用于 PR
          ISSUE_TITLE=$(gh issue view "${ISSUE_NUMBER}" --json title --jq '.title')

          # 2. 创建或复用 feature 分支 (幂等)
          git fetch origin
          # 尝试直接切换，失败则创建
          if ! git checkout -B "${BRANCH_NAME}" "origin/${BRANCH_NAME}" 2>/dev/null; then
            git checkout -b "${BRANCH_NAME}" origin/master
            git commit --allow-empty -m "chore: initialize branch for #${ISSUE_NUMBER}"
            git push -u origin "${BRANCH_NAME}"
          fi

          # 3. 创建或复用 draft PR (幂等)
          PR_NUMBER=$(gh pr list --head "${BRANCH_NAME}" --state open --json number --jq '.[0].number')
          if [ -n "${PR_NUMBER}" ]; then
            echo "PR #${PR_NUMBER} already exists, reusing"
          else
            echo "Creating draft PR"
            PR_URL=$(gh pr create \
              --title "#${ISSUE_NUMBER} ${ISSUE_TITLE}" \
              --body "Closes #${ISSUE_NUMBER}" \
              --base master \
              --head "${BRANCH_NAME}" \
              --draft)
            PR_NUMBER=$(echo "${PR_URL}" | grep -oE '/pull/[0-9]+' | grep -oE '[0-9]+')
          fi

          echo "Setup complete: PR #${PR_NUMBER} on branch ${BRANCH_NAME}"

          # 4. 给 PR 打标签: stage:ready (触发 agent-work job) + fastlane/type:* (从 Issue 同步)
          PR_LABELS="stage:ready"
          ISSUE_LABELS=$(gh issue view "${ISSUE_NUMBER}" --json labels --jq '.labels[].name')
          if echo "${ISSUE_LABELS}" | grep -q "^fastlane$"; then
            PR_LABELS="${PR_LABELS},fastlane"
          fi
          # 同步 type:* 标签（type:feature / type:bug / type:refactor）
          TYPE_LABEL=$(echo "${ISSUE_LABELS}" | grep "^type:" | head -n 1)
          if [ -n "${TYPE_LABEL}" ]; then
            PR_LABELS="${PR_LABELS},${TYPE_LABEL}"
          fi
          # 注意: GITHUB_TOKEN 触发的 label 事件不会再次触发 workflow，
          # 因此需要使用 PAT 或 GitHub App token 来触发 agent.yml 的 agent-work job。
          gh pr edit "${PR_NUMBER}" --add-label "${PR_LABELS}"

          # 5. 更新 Issue 状态: backlog → in-progress (幂等)
          gh issue edit "${ISSUE_NUMBER}" \
            --add-label "status:in-progress" \
            --remove-label "status:backlog"

      - name: Report Setup Failure
        if: failure()
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GH_REPO: ${{ github.repository }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          gh issue edit "${ISSUE_NUMBER}" --add-label "human:help-needed"

          COMMENT_FILE=$(mktemp)
          printf '**PR Setup Failed**\n\nFailed to create branch/PR for this issue.\n\n**Run Details:** %s\n\nPlease review the logs.' "${RUN_URL}" > "${COMMENT_FILE}"
          gh issue comment "${ISSUE_NUMBER}" --body-file "${COMMENT_FILE}"
          rm -f "${COMMENT_FILE}"
