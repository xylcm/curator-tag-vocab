name: Claude Auto-Dev Agent

on:
  issues:
    types: [labeled]
  pull_request:
    types: [labeled]

jobs:
  write-prd:
    if: github.event_name == 'issues' && github.event.label.name == 'status:backlog'
    runs-on: self-hosted

    steps:
      - name: Update Issue labels
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --remove-label "status:backlog" \
            --add-label "status:in-progress"

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude PRD Draft
        shell: zsh {0}
        run: |
          source ~/.zshrc
          export PATH=$PATH:/opt/homebrew/bin:/usr/local/bin
          
          claude -p "@.claude/prd_draft_instructions.md Handle GitHub Issue #${{ github.event.issue.number }}" \
            --permission-mode bypassPermissions < /dev/null

  implement-prd:
    if: github.event_name == 'pull_request' && github.event.label.name == 'action:implement'
    runs-on: self-hosted

    steps:
      - name: Resolve Issue Number and update PR labels
        id: resolve
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          ISSUE_NUMBER="${BRANCH_NAME#agent/issue-}"

          if [ -z "$ISSUE_NUMBER" ] || ! [[ "$ISSUE_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "::error::Failed to resolve issue number from PR branch '$BRANCH_NAME' (expected pattern: agent/issue-{N})"
            exit 1
          fi

          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          echo "Resolved Issue Number: #$ISSUE_NUMBER"

          gh pr edit ${{ github.event.pull_request.number }} --remove-label "status:prd-review"

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude PRD Implement
        shell: zsh {0}
        run: |
          source ~/.zshrc
          export PATH=$PATH:/opt/homebrew/bin:/usr/local/bin
          
          claude -p "@.claude/prd_implement_instructions.md Implement PR #${{ github.event.pull_request.number }} for Issue #${{ steps.resolve.outputs.issue_number }}, PRD file: @docs/prds/issue-${{ steps.resolve.outputs.issue_number }}.md" \
            --permission-mode bypassPermissions < /dev/null
